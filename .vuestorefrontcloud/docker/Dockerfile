FROM node:16-alpine

ARG COMMIT
ARG NPM_USER
ARG NPM_PASS
ARG NPM_EMAIL
ARG NPM_REGISTRY
ARG BIGCOMMERCE_API_CLIENT_ID
ARG BIGCOMMERCE_API_CLIENT_SECRET
ARG BIGCOMMERCE_API_URL
ARG BIGCOMMERCE_API_ACCESS_TOKEN
ARG BIGCOMMERCE_STORE_ID
ARG BIGCOMMERCE_STORE_GUEST_TOKEN
ARG API_BASE_URL
ARG API_SSR_BASE_URL
ARG DEFAULT_CHANNEL_ID
ARG MIDDLEWARE_ALLOWED_ORIGINS

ENV LAST_COMMIT=${COMMIT}
ENV BIGCOMMERCE_API_CLIENT_ID=${BIGCOMMERCE_API_CLIENT_ID}
ENV BIGCOMMERCE_API_CLIENT_SECRET=${BIGCOMMERCE_API_CLIENT_SECRET}
ENV BIGCOMMERCE_API_URL=${BIGCOMMERCE_API_URL}
ENV BIGCOMMERCE_API_ACCESS_TOKEN=${BIGCOMMERCE_API_ACCESS_TOKEN}
ENV BIGCOMMERCE_STORE_ID=${BIGCOMMERCE_STORE_ID}
ENV BIGCOMMERCE_STORE_GUEST_TOKEN=${BIGCOMMERCE_STORE_GUEST_TOKEN}
ENV API_BASE_URL=${API_BASE_URL}
ENV API_SSR_BASE_URL=${API_SSR_BASE_URL}
ENV DEFAULT_CHANNEL_ID=${DEFAULT_CHANNEL_ID}
ENV MIDDLEWARE_ALLOWED_ORIGINS=${MIDDLEWARE_ALLOWED_ORIGINS}

RUN npm install -g npm-cli-login && npm-cli-login

WORKDIR /var/www

COPY . .

RUN yarn install --network-concurrency 1 && yarn build && yarn cache clean --all

COPY .vuestorefrontcloud/docker/vue-storefront.sh /usr/local/bin/

ENTRYPOINT ["vue-storefront.sh"]

